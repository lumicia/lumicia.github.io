---
title: "OSTEP Chap2 01：进程"
date: 2021-09-08T16:50:08+08:00
categories: ["OS"]
tags: ["OSTEP"]
draft: false
---

一个进程就是一个正在运行的程序。一个程序由许多指令和可能存在的静态数据组成。程序存储在硬盘中，由操作系统负责程序的运行。

一个 CPU 一次只能执行一个指令，因此一次也只能执行一个程序。同时运行多个程序是操作系统创造出来的一个假象。操作系统使用的方法是将 CPU 虚拟化，运行一个进程，然后暂停，运行另一个进程，以此类推。这样就好像有多个 CPU 存在，而实际只有一个 CPU。这种方法称为 CPU 的分时（time sharing），让用户能运行多个并发的进程。潜在的代价是性能，如果有非常多的进程共享 CPU，可能每个进程都会运行得更慢。

CPU 的虚拟化需要底层和上层的技术配合。底层的技术称为机制（mechanism），是实现功能所必需的方法或协议，如上下文切换、分时；上层的称为策略（policy），是操作系统做出决策的算法，如调度。机制和策略的分离实现了软件设计的模块化原则。

理解进程需要理解进程的机器状态：一个程序在运行过程中能够读取或更新的事物。

机器状态的一个组成部分是内存。指令位于内存，进程读写的数据也位于内存。因此内存中进程能够寻址的部分属于进程的一部分，称为进程的地址空间（address space）。

机器状态的另一个组成部分是寄存器。许多指令显式读取或更新寄存器，因此寄存器对于进程的执行也是非常重要的。

有一些特殊的寄存器也是机器状态的组成部分：

- 程序计数器（program counter，PC）用于指示接下来要执行的指令；
- 栈指针（stack pointer）和关联的帧指针（frame pointer）用于管理函数参数的栈、局部变量和返回地址。

最后，硬盘上进程能够访问的文件也是进程机器状态的一部分。

操作系统应该为进程实现的接口：

- 创建；
- 销毁；
- 等待；
- 其他控制方法；
- 状态。

## 进程创建

为了运行一个程序，操作系统需要将程序代码和任何需要的静态数据装载到进程在内存中的地址空间。程序在装载到内存之前以某种可执行文件的格式存储在硬盘中，然后由操作系统从硬盘中读取并存放到内存中的某个位置。

在现代操作系统中装载的过程是惰性的，仅在程序执行需要时才装载所需的部分代码或数据。惰性装载与分页（paging）和交换（swapping）有关。

代码和静态数据装载到内存后，操作系统需要为程序的运行时栈（run-time stack）分配内存。操作系统可能用参数把这个栈初始化，特别地，参数传递给 `main()` 函数的 `argc` 形参和 `argv` 数组形参。

操作系统也要为程序的堆分配内存。堆用于显式请求的动态分配数据。程序通过 `malloc()` 请求堆空间，`free()` 释放空间。堆是链表、散列表和树等数据结构所必需的。

操作系统还会为相关的 I/O 设置执行初始化任务。

最后操作系统跳转到入口点 `main()` 函数开始执行程序。操作系统将 CPU 的控制权转交给新创建的进程，然后程序开始执行。

## 进程状态

进程有三种状态：

- 运行：运行状态的进程正在处理器上运行。
- 就绪：就绪状态的进程准备好要运行，但操作系统在该时刻还未选择它来运行。
- 阻塞：阻塞状态的进程执行一些操作，还没有准备好要执行。如初始化一个进程到硬盘的 I/O 请求会阻塞进程，让其他进程使用处理器。

进程从就绪状态转换为运行状态称为调度（scheduled），从运行状态转换为就绪状态称为解调度（descheduled）。操作系统的调度器（scheduler）负责调度的决策。

进程阻塞时（如初始化一个 I/O 操作），操作系统将保持该进程直到一些事件发生（如 I/O 操作完成），此时进程转换到运行状态。

## 进程中的数据结构

操作系统中有许多关键的数据结构来追踪与进程相关的信息。如操作系统通过进程列表来追踪就绪的进程，再加上一些额外信息来追踪正在运行的进程。

在五态模型中，进程还有初始状态和终止状态。

进程控制块（Process Control Block）：单独存储一个进程相关信息的结构体。
