---
title: "计算机网络 Chap3 07：TCP 拥塞控制"
date: 2021-05-31T11:07:46+08:00
categories: ["Computer Networking"]
tags: ["计算机网络：自顶向下方法"]
draft: false
---

TCP 必须使用端到端拥塞控制而非网络辅助拥塞控制，因为 IP 层没有向端系统显式提供网络拥塞反馈。

TCP 所采用的方式是让每个发送端根据所感知到的网络拥塞程度来限制其能向连接发送流量的速率。如果感知到几乎没有拥塞，则增大发送速率，反之减小发送速率。这个方法需要解决三个问题：

1. TCP 发送端如何限制发送到连接中的流量速率？
2. TCP 发送端如何感知它和目的地之间的拥塞？
3. 发送端感知到端到端拥塞时，使用什么算法来改变发送速率？

<!--more-->

TCP 连接的每一端都由一个接收缓冲、一个发送缓冲和几个变量组成。发送端的拥塞控制机制跟踪一个额外的变量，称为拥塞窗口（congestion window），记为`cwnd`。拥塞窗口对一个TCP 发送端能向网络中发送流量的速率进行了限制。

通过约束发送端中未被确认的数据的数量，来间接限制发送端的发送速率。在每个往返时间（RTT）的起始点，上面的限制条件允许发送端向该连接发送`cwnd`个字节的数据，在该RTT结束时发送端接收对该数据的确认报文。因此发送端的发送速率大约为`cwnd/RTT`字节每秒。通过调节`cwnd`的值，发送端可以调节向连接发送数据的速率。

TCP 发送端的丢包事件定义：要么出现超时，要么接收到来自接收端的3个冗余ACK。当出现过度拥塞时，在沿着这条路径上的一台（或多台）路由器的缓冲会溢出，导致丢弃一个数据报。丢弃的数据报接着会引起发送端的丢包事件，此时发送端就认为到接收端的路径上出现了拥塞的指示。

因为TCP 使用确认来触发（或计时）增大它的拥塞窗口长度，称TCP 是自计时的（self-clocking）。

TCP 拥塞算法包括3个主要部分：

1. 慢启动；
2. 拥塞避免；
3. 快速恢复。

### 慢启动

当TCP 连接开始时，`cwnd`的值通常初始化为一个MSS的较小值，这样初始发送速率大约为`MSS/RTT`。由于TCP 发送端的可用带宽可能比`MSS/RTT`大得多，TCP 发送端希望迅速找到可用带宽的数量。因此，在慢启动状态，`cwnd`的值以1个MSS开始，并且每当传输的报文段首次确认就增加1个MSS。这样，每过一个RTT，发送速率就翻倍，发送速率以指数增长。

慢启动结束的三种方式：

1. 如果存在一个由超时指示的丢包事件（即拥塞），TCP 发送端将`cwnd`的值设为`1`，并重新开始慢启动过程。此外还将第二个状态变量`ssthresh`（slow start threshold）的值设为`cwnd/2`，即当检测到拥塞时将`ssthresh`设置为拥塞窗口值的一半。
2. 因为上次检测到拥塞时将`ssthresh`的值设为`cwnd/2`，当这次`cwnd`的值到达或超过`ssthresh`时，结束慢启动，TCP 传输进入拥塞避免模式。
3. 如果检测到冗余ACK，TCP 执行快速重传并进入到快速恢复状态。

![TCP 拥塞控制 FSM](https://i.loli.net/2021/06/01/TxQcgsy6oEGwpFv.png)

### 拥塞避免

进入拥塞避免状态时，`cwnd`的值大约是上次遇到拥塞时的一半，此时可能又要遇到拥塞。此时，TCP 在每个RTT保守地以1个MSS来增加`cwnd`的值。一种通常的方式是TCP 发送端无论何时到达一个新的确认时，以MSS个字节增加`cwnd`。

拥塞避免结束：出现超时时，TCP 拥塞避免算法和慢启动行为一致。`cwnd`的值设为1MSS，`ssthresh`的值在丢包事件发生时更新为`cwnd`的一半。丢包事件也可能因三冗余ACK事件触发。此时，网络继续从发送端向接收端交付报文段。TCP 将`cwnd`的值减半（为更好地度量，考虑到三冗余ACK，加上3个MSS），并当接收到三冗余ACK时将`ssthresh`的值记录为`cwnd`值的一半。然后进入快速恢复模式。

### 快速恢复

在快速恢复时，对于引起TCP 进入快速恢复模式的缺失报文段，对接收到的每个冗余ACK`cwnd`的值增加1个MSS。最终，当对缺失报文段的一个ACK到达时，TCP 在降低`cwnd`的值后进入拥塞避免状态。如果超时事件发生，快速恢复在执行如同在慢启动和拥塞避免中相同的动作后，转移到慢启动状态：当丢包事件出现时，`cwnd`的值设为1个MSS，并且将`ssthresh`的值设为`cwnd`值的一半。

TCP 拥塞控制常称为加性增、乘性减（Additive-Increase，Multiplicative-Decrease，AIMD）拥塞控制方式。

如果拥塞链路中分组丢失的状态没有改变多少，则快速增加发送速率到接近丢包前的速率，然后仅小心地嗅探带宽。这就是TCP CUBIC 的核心。

一条连接的平均吞吐量等于$\cfrac{0.75\times W}{RTT}$字节每秒，W是发生丢包事件时的窗口长度。

## 网络辅助的显式拥塞通知和基于延迟的拥塞控制

显式拥塞通知（Explicit Congestion Notification，ECN）是一种在互联网上执行的网络辅助拥塞控制的形式。在网络层的IP 数据报首部的服务类型字段设置两个位，用于ECN。

基于延迟的拥塞避免方法是在分组丢失发生前主动检测拥塞的起始。

## 公平性

如果经过同一瓶颈链路的每条TCP 连接都得到相同份额的链路带宽，则认为该拥塞控制机制是公平的。

