---
title: "Fluent Python Chap7：一等函数"
date: 2021-05-13T17:20:12+08:00
categories: ["Python"]
tags: ["Fluent Python"]
draft: false
---

一等对象的定义：

- 在运行时创建；
- 能赋值给变量或数据结构中的元素；
- 能作为参数传给函数；
- 能作为函数的返回结果。

在 Python 中，函数、整数、字符串和字典都是一等对象。

<!--more-->

创建一个函数后，调用函数，读取它的 `__doc__` 属性，并且确定函数对象本身是 `function` 类的实例。

`__doc__` 属性用于生成对象的帮助文本。

## 高阶函数

接受函数作为参数，或吧函数作为结果返回的函数是高阶函数（higher-order function）。如 `map`、`sorted` 函数。

函数式语言通常会提供 `map`、`filter` 和 `reduce` 三个高阶函数。列表推导或生成器表达式具有 `map` 和 `filter` 两个函数的功能，而且更易于阅读。Python 3 将 `reduce` 函数放在 `functools` 模块中，最好使用内置的 `sum` 函数来替代。

`all(iterable)`：如果 `iterable` 的每个元素都是真值，返回 `True`；`all([])` 返回 `True`。
`any(iterable)`：只要 `iterable` 中有元素是真值，就返回 `True`；`any([])` 返回 `False`。

## 匿名函数

`lambda` 关键字在 Python 表达式内创建匿名函数。

`lambda` 函数的定义体只能使用纯表达式。`lambda` 函数的定义体中不能赋值，也不能使用 `while` 和 `try` 等 Python 语句。

## 可调用对象

除了用户定义的函数，调用运算符（即 `()`）还可以应用到其他对象上。如果想判断对象能否调用，可以使用内置的 `callable()` 函数。Python 数据模型文档列出了 7 种可调用对象。

- 用户定义的函数：使用 `def` 语句或 `lambda` 表达式创建；
- 内置函数：使用 C 语言实现的函数，如 `len` 或 `time.strftime`；
- 内置方法：使用 C 语言实现的方法，如 `dict.get`；
- 方法：在类的定义体中定义的函数；
- 类：调用类时会运行类的 `__new__` 方法创建一个实例，然后运行 `__init__` 方法，初始化实例，最后把实例返回给调用方。因为 Python 没有 `new` 运算符，所以调用类相当于调用函数；
- 类的实例：如果类定义了 `__call__` 方法，那么它的实例可以作为函数调用；
- 生成器函数：使用 `yield` 关键字的函数或方法。调用生成器函数返回的是生成器对象。

## 用户定义的可调用类型

不仅 Python 函数是真正的对象，任何 Python 对象都可以表现得像函数。为此，只需实现实例方法 `__call__`。

实现 `__call__` 方法的类是创建函数类对象的简便方式，此时必须在内部维护一个状态，让它在调用之间可用。装饰器就是这样。装饰器必须是函数，而且有时要在多次调用之间“记住”某些事（例如 memoization，缓存消耗大的计算结果，供后面使用）。

还可以用闭包创建保存内部状态的函数。

## 函数内省

除了 `__doc__`，函数对象还有很多属性。使用 `dir` 函数可以探知函数属性。

与用户定义的常规类一样，函数使用 `__dict__` 属性存储赋予它的用户属性。

## 从定位参数到仅限关键字参数

Python 3 提供了仅限关键字参数（keyword-only argument）。调用函数时使用 `*` 和 `**` 运算符「展开」可迭代对象，映射到单个参数。

`*args`  收集所有未匹配的位置参数存入一个元组，`**kw` 收集所有未匹配的关键字参数存入一个字典。

定义函数时若想指定仅限关键字参数，要把它们放到前面有 `*` 的参数后面。如果不想支持数量不定的定位参数，但是想支持仅限关键字参数，在签名中放一个 `*`。

函数对象有个 `__defaults__` 属性，它的值是一个元组，里面保存着定位参数和关键字参数的默认值。仅限关键字参数的默认值在 `__kwdefaults__` 属性中。然而，参数的名称在 `__code__` 属性中，它的值是一个 `code` 对象引用，自身也有很多属性。

`inspect` 模块展示了 Python 数据模型把实参绑定给函数调用中的形参的机制，这与解释器使用的机制相同。