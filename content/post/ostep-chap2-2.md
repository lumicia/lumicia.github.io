---
title: "Ostep Chap2 02：受限直接执行"
date: 2021-09-09T17:56:04+08:00
categories: ["OS"]
tags: ["OSTEP"]
draft: false
---

操作系统通过 CPU 分时来实现 CPU 的虚拟化，会在性能和控制上遇到挑战。

受限直接执行（limited direct execution）机制可以让程序运行得像期望中那样快。

直接执行就是让程序直接在 CPU 上运行。直接执行的两个问题：

- 操作系统如何确定程序在高效运行之时不做其他预料之外的事情。
- 操作系统如何停止一个进程，然后切换到另一个进程。

第一个问题通过将进程分为用户态和内核态来解决。

处于用户态的代码能进行的操作会受到限制。

操作系统自身处于内核态。处于内核态的代码能进行特权操作，如发送 I/O 请求，执行所有类型的受限指令等。

为了让用户程序能执行特权操作，硬件为用户程序提供了执行系统调用的能力。为了执行系统调用，用户程序需要先执行一个特殊的陷入（trap）指令。该指令同步陷入内核，并提升特权级到内核态。处于内核态之后，系统能执行任何所需的特权操作，从而为调用进程做要做的任务。任务完成后，操作系统调用一个特殊的从陷入返回（return-from-trap）指令，该指令返回到调用用户程序，同时降低特权级到用户态。

为了让陷入知道要执行操作系统中的哪些代码，内核会在启动的时候设置一个陷入表（trap table）。操作系统首先要做的事情之一是告诉硬件发生异常事件时应该运行哪些代码。操作系统会通知硬件这些陷入处理程序的位置及一些特殊指令。

为了区分系统调用，每个系统调用都分配了一个编号。

受限直接执行协议有两个阶段。第一个阶段在启动的时候。第二给阶段在运行进程的时候。

---

第二个问题通过定时器中断让一个进程暂停，让出控制。然后在操作系统中预先配置的中断处理程序会运行。此时操作系统会获得对 CPU 的控制，从而停止当前进程，让另一个进程开始运行。

操作系统必须在中断发生时通知硬件运行哪些代码。在启动时和启动顺序期间，操作系统必须启动定时器（这是一个特权操作）。一旦定时器启动后，就可以确保控制最终会返回给操作系统。硬件需要负责保存进程在中断时的状态，从而使后续的从陷入返回指令能正确地将该进程恢复运行。

决定接下来运行哪个进程则是调度器负责的。如果决定切换进程，操作系统就会执行上下文切换（context switch）。上下文切换就是操作系统会为当前执行的进程保存几个寄存器的值，为接下来要执行的进程保存几个寄存器的值。这样操作系统可以确保当从陷入返回指令执行的时候，恢复执行其他进程，而非刚刚运行的进程。

为了保存当前运行进程的上下文，操作系统将执行一些底层的汇编代码来保存当前运行进程的通用寄存器、PC、内核栈指针，然后保存上述寄存器、PC 并切换到接下来执行进程的内核栈。通过切换栈，在被中断的进程的上下文中，内核进入切换代码的调用，并在接下来要执行的进程的上下文中返回。当操作系统最终执行从陷入返回指令，接下来要执行的进程成为当前运行的进程，从而完成上下文切换。

在上下文切换中有两种类型的寄存器。第一种在发生定时器中断时，当前进程的用户寄存器隐式地被硬件使用该进程的内核栈保存。第二种当操作系统切换进程时，内核寄存器显式地被软件（即操作系统）保存，但保存在该进程在内存中的进程结构中。

