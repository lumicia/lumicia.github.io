---
title: "计算机网络 Chap3 05：TCP"
date: 2021-05-14T13:25:10+08:00
categories: ["Computer Networking"]
tags: ["计算机网络：自顶向下方法"]
draft: false
---

TCP 是面向连接的，因为在应用进程发送数据给其他进程之前，两个进程之间必须先「握手」，即它们必须发送一些预备报文段给对方，以建立确保数据传输的参数。作为 TCP 连接建立的一部分，连接的双方都将初始化与 TCP 连接相关的许多 TCP 状态变量。

TCP 连接提供的是全双工服务（full-duplex service），应用层数据在两个进程之间同时双向流动。

TCP 连接总是点对点的（point-to-point），在单个发送端和单个接收端之间连接。

<!--more-->

TCP 连接建立的过程：客户端首先发送一个特殊的 TCP 报文段；服务器用第二个特殊的 TCP 报文段响应；最后客户端用第三个特殊的 TCP 报文段响应。前两个报文段不包含载荷，没有应用层数据；第三个报文段可能有载荷。因为在两个主机之间发送了三个报文段，该连接建立的过程通常称为三次握手（three-way handshake）。

建立连接后，客户端进程通过套接字传输数据流。一旦数据通过套接字，数据由客户端中运行的 TCP 控制。TCP 将这些数据导入连接的发送缓冲（send buffer）中，发送缓冲是开始的三次握手中设置的几个缓冲之一。TCP 不时从发送缓冲中取出一块（chunk）数据。

TCP 从发送缓冲中取出并放到报文段中的数据的最大数量通过 MSS（maximum segment size）限制。MSS 通常根据最初确定的由本地发送主机发送的最大链路层帧长度（称为 maximum transmission unit，MTU），接着设置 MSS 来确保 TCP 报文段（在封装为 IP 数据报的时候）加上 TCP/IP 首部长度（通常是 40 字节）在单个链路层帧范围内。以太网和 PPP 链路层协议都具有 1500 字节的 MTU。因此 MSS 通常是 1460 字节。

注意 MSS 指报文段中最大的应用层数据长度，不包括 TCP 报文段首部。

TCP 为每块客户端数据配上一个 TCP 首部，从而形成 TCP 报文段。报文段向下传输给网络层，在网络层 IP 数据报中分别封装。然后这些 IP 数据报被发送到网络中。另一端的 TCP 接收到一个报文段后，将该报文段的数据放入 TCP 连接的接收缓冲中。应用从该缓冲中读取数据流。连接的每一端都有自己的发送缓冲和接收缓冲。

一个 TCP 连接的组成包括：一台主机上的缓冲、变量、与进程连接的套接字以及另一条台主机上的缓冲、变量和与进程连接的套接字。

## TCP 报文段结构

TCP 报文段由首部字段和一个数据字段组成。数据字段包括一块应用数据。

TCP 首部包括：

- 源端口号和目的端口号；
- 检验和字段；
- 32 比特的序号字段（sequence number field）和 32 比特的确认号字段（acknowledgement number field）；
- 16 比特的接收窗口字段（receive window field），用于流量控制；
- 4 比特的首部长度字段（header length field），指示了以 32 比特的字为单位的 TCP 首部长度；
- 可选与变长的选项字段（options field），用于发送端和接收端协商最大报文段长度时或在高速网络环境下用作窗口调节因子时使用；
- 6 比特的标志字段（flag field）。

<img src="https://i.loli.net/2021/05/14/h184n56qrsomDxH.png" alt="image.png" style="zoom:50%;" />

### 序号和确认号

序号和确认号是 TCP 报文段首部中最重要的两个字段。

TCP 把数据看成一个无结构的、有序的字节流。序号是建立在传送的字节流之上的。一个报文段的序号因此是该报文段首字节的字节流编号。

TCP 是全双工的，因此主机 A 在发送数据给主机 B 的同时，可能在同一条 TCP 连接接收来自主机 B 的数据。从主机 B 到达的每个报文段中都有一个序号用于从B流向A的数据。主机A写入报文段的确认号是主机A期望从主机B收到的下一字节的序号。

TCP 只确认数据流中到第一个丢失字节为止的字节，因此 TCP 提供了累积确认（cumulative acknowledgement）。

对于主机在 TCP 连接中接收到的失序报文段，通常接收端会保留失序的字节，等待缺少的字节以填补该间隔。

TCP 连接的双方可以随机地选择初始序号。这样做可以减少将那些仍在网络中存在的来自两台主机间之前已终止的连接的报文段，误认为是后来的两台主机间新建连接所产生的有效报文段的可能性。

## TCP 的可靠数据传输

TCP 通过超时和冗余确认技术来提供可靠数据传输。

即使有多个未确认的报文段，TCP 定时器管理过程仅使用单个重传定时器，从而避免因多个定时器引起的性能开销。

与 TCP 发送端数据传输和重传相关的三个主要事件：

- 从上层的应用接收数据；
- 超时；
- 接收 ACK。

超时间隔在每次发生超时事件后加倍。

冗余 ACK（duplicate ACK）就是再次确认某个报文段的 ACK，而发送端先前已经收到对该报文段的确认。发送端通常可在超时事件发生之前通过注意冗余 ACK 来检测丢包情况。

收到 3 个冗余 ACK 后，TCP 执行快速重传（fast retransmit），即在该报文段的定时器过期之前重传丢失的报文段。

## 流量控制

TCP 为应用提供了流量控制服务（flow-control service）来消除发送端将接收端缓冲溢出的可能性。

发送端维持一个变量称为接收窗口（receive window）。接收窗口用于知晓在接收端有多少自由的缓冲空间。

## TCP 连接管理

当一个在客户端主机运行的进程想要初始化一个与服务器进程之间的连接，客户端应用进程首先通知客户端 TCP，然后客户端 TCP 以下述步骤与服务器的 TCP 建立 TCP 连接。

1. 客户端 TCP 发送一个特殊的 TCP 报文段给服务器端 TCP 。这个报文段称为 SYN 报文段。SYN 位设为 1。
2. 一旦包含 TCP SYN 报文段的 IP 数据报到达服务器主机，服务器将 TCP SYN 报文段从数据报中解压出来，给连接分配 TCP 缓冲和变量，并发送一个连接许可报文段给客户端 TCP 。连接许可报文段称为 SYNACK 报文段。SYN 位设为 1。
3. 接收 SYNACK 报文段后，客户端也给连接分配缓冲和变量。客户端主机也会发送其他报文段给服务器，这个报文段确认服务器的连接许可报文段。SYN 位设为 0。

完成上面三步之后，客户端和服务器主机可以发送包含数据的报文段给对方。这时每一个报文段中的 SYN 位都设为 0。

为了建立连接，在两个主机之间发送了 3 个报文段，因此连接建立过程称为三次握手（three-way handshake）。

![TCP 三次握手](https://i.loli.net/2021/05/26/WJX9vZfzDRrVtdB.png)

TCP 连接的两个进程任一都可以结束 TCP 连接。结束连接时，主机资源（缓冲和变量）解分配。

假如客户端决定关闭连接。客户端应用进程发送关闭命令，这会使客户端 TCP 发送一个特殊的 TCP 报文段给服务器进程，FIN 位设为 1。服务器接收到这个报文段后，发送一个确认报文段给客户端。服务器接着发送它自己的关闭报文段，将 FIN 位设为 1。最后，客户端确认服务器的关闭报文段。

![TCP 连接关闭四次挥手](https://i.loli.net/2021/05/26/u5Xr7PzlECmwbRK.png)

在 TCP 连接的生命周期中，运行在每个主机中的 TCP 协议在几个 TCP 状态之间转化。

客户端 TCP 从 CLOSED 状态开始。

![客户端 TCP 的状态转化](https://i.loli.net/2021/05/26/jRWNCSHDe2MmULh.png)

服务器监听客户端发送 SYN 报文段的端口。

![服务器 TCP 状态转化](https://i.loli.net/2021/05/26/4OALcplxso7vUhB.png)
